<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sooying.pay.app.api.dao.platform.database.QueryPlatformDao">

	<select id="selectOverallDataInfo" parameterType="java.lang.Integer"
		resultType="OverallDataInfo">
        SELECT a.appId,
               a.requestCount,
               a.confirmCount,
               a.successCount,
               a.noPassagewayCount,
               a.noCardCount,
               CASE WHEN a.confirmCount > 0 THEN ROUND(a.successCount::numeric/a.confirmCount::numeric,4) ELSE 0 END as successRate,
               CASE WHEN a.requestCount > 0 THEN ROUND(a.realAmount::numeric/a.requestCount::numeric,4) ELSE 0 END as successArpu,
               CASE WHEN a.requestCount > 0 THEN ROUND(a.riskCount::numeric/a.requestCount::numeric,4) ELSE 0 END as riskRate,
               CASE WHEN a.requestCount > 0 THEN ROUND(a.noPassagewayCount::numeric/a.requestCount::numeric,4) ELSE 0 END as noPassagewayRate
        FROM
           (
            SELECT app_id as appId,
                   count(distinct(CASE WHEN status in('0','1','2','3','4') THEN imei END)) AS requestCount,
                   count(distinct(CASE WHEN status in('0','1') THEN imei END)) AS confirmCount,
                   count(distinct(CASE WHEN status = '1' THEN imei END)) AS successCount,
                   count(distinct(CASE WHEN status = '3' THEN imei END)) AS noPassagewayCount,
                   count(distinct(CASE WHEN status = '4' THEN imei END)) AS riskCount,
                   SUM(CASE WHEN status ='1' THEN real_amount ELSE 0 END)/100 as realAmount,
                   count(distinct(CASE WHEN status in('0','1','2','3','4') and (imsi = '0' or imsi is null or imsi = '') THEN imei END)) AS noCardCount
            FROM dp_open_pay_order_result
            where pay_time >= current_date-1
              and pay_time &lt; current_date
              and app_id = #{appId}
            group by appId having count(distinct(CASE WHEN status in('0','1') THEN imei END)) > 0
           ) a
	</select>
	
    <select id="selectSuccessRateInfoCount" parameterType="java.util.HashMap"
        resultType="java.lang.Integer">
        SELECT count(*)
        FROM
           (
            SELECT passageway_id as passagewayId
            FROM dp_open_pay_order_result
            where pay_time >= current_date
              <if test="passagewayId != null and passagewayId != ''">
                  and passageway_id = #{passagewayId}
              </if>
            group by passageway_id having count(distinct(CASE WHEN status in('0','1') THEN imei END)) > 0
           ) a
    </select>
	
    <select id="selectSuccessRateInfoList" parameterType="java.util.HashMap"
        resultType="SuccessRateInfo">
        SELECT a.passagewayId,
               c.passageway_name as passagewayName,
               a.requestCount,
               a.confirmCount,
               a.successCount,
               a.riskCount,
               COALESCE(b.mrCount,0) as mrCount,
               CASE WHEN a.confirmCount > 0 THEN ROUND(a.successCount::numeric/a.confirmCount::numeric,4) ELSE 0 END as successRate,
               CASE WHEN a.successCount > 0 THEN ROUND(COALESCE(b.mrCount,0)::numeric/a.successCount::numeric,4) ELSE 0 END as syncRate
        FROM
           (
            SELECT passageway_id as passagewayId,
                   count(distinct(CASE WHEN status in('0','1','2','3','4') THEN imei END)) AS requestCount,
                   count(distinct(CASE WHEN status in('0','1') THEN imei END)) AS confirmCount,
                   count(distinct(CASE WHEN status ='1' THEN imei END)) AS successCount,
                   count(distinct(CASE WHEN status ='4' THEN imei END)) AS riskCount
            FROM dp_open_pay_order_result
            where pay_time >= current_date
              <if test="passagewayId != null and passagewayId != ''">
                  and passageway_id = #{passagewayId}
              </if>
            group by passageway_id having count(distinct(CASE WHEN status in('0','1') THEN imei END)) > 0
           ) a
        LEFT JOIN
           (
            SELECT sp_code,
                   count(*) as mrCount
            from dp_third_note_pay_result
            where create_time >= current_date
              and status_desc = '1'
              <if test="passagewayId != null and passagewayId != ''">
                  and sp_code = #{passagewayId}
              </if>
            group by sp_code
           ) b 
               ON a.passagewayId = b.sp_code
        LEFT JOIN dp_note_info c
               ON a.passagewayId = c.passageway_id
        order by successRate desc
        limit #{rowsPerPage} offset #{start}
    </select>

    <select id="selectProvinceSuccessRateInfoCount" parameterType="java.util.HashMap"
        resultType="java.lang.Integer">
        SELECT count(*)
        FROM
           (
            SELECT net_type,
                   province
            FROM dp_open_pay_order_result
            where pay_time >= current_date-1
              and pay_time &lt; current_date
              <if test="netType != null and netType != ''">
                  and net_type = #{netType}
              </if>
              <if test="province != null and province != ''">
                  and province = #{province}
              </if>
            group by net_type,province having count(distinct(CASE WHEN status in('0','1') THEN imei END)) > 0
           ) a
    </select>
    
    <select id="selectProvinceSuccessRateInfoList" parameterType="java.util.HashMap"
        resultType="ProvinceSuccessRateInfo">
        SELECT a.province,
               a.netType,
               a.requestCount,
               a.confirmCount,
               a.successCount,
               a.riskCount,
               CASE WHEN a.confirmCount > 0 THEN ROUND(a.successCount::numeric/confirmCount::numeric,4) ELSE 0 END as successRate
        FROM
           (
            SELECT net_type as netType,
                   province,
                   count(distinct(CASE WHEN status in('0','1','2','3','4') THEN imei END)) AS requestCount,
                   count(distinct(CASE WHEN status in('0','1') THEN imei END)) AS confirmCount,
                   count(distinct(CASE WHEN status ='1' THEN imei END)) AS successCount,
                   count(distinct(CASE WHEN status ='4' THEN imei END)) AS riskCount
            FROM dp_open_pay_order_result
            where pay_time >= current_date-1
              and pay_time &lt; current_date
              <if test="netType != null and netType != ''">
                  and net_type = #{netType}
              </if>
              <if test="province != null and province != ''">
                  and province = #{province}
              </if>
            group by net_type,province having count(distinct(CASE WHEN status in('0','1') THEN imei END)) > 0
           ) a
        order by successRate desc
        limit #{rowsPerPage} offset #{start}
    </select>
    
    <select id="selectOverallFeeInfoCount" parameterType="java.util.HashMap"
        resultType="java.lang.Integer">
        select count(*)
        from
           (
            select sp_code as passagewayId
            from dp_third_note_pay_result
            where create_time >= current_date - 1
              and create_time &lt; current_date
              and status_desc = '1'
              <if test="passagewayId != null and passagewayId != ''">
                  and sp_code = #{passagewayId}
              </if>
            group by passagewayId
           ) a
    </select>
    
    <select id="selectOverallFeeInfoList" parameterType="java.util.HashMap"
        resultType="OverallFeeInfo">
        select a.statisDate,
               a.passagewayId,
               b.passageway_name as passagewayName,
               a.fee
        from
           (
            select current_date - 1 as statisDate,
                   sp_code as passagewayId,
                   sum(pay_money/100) as fee
            from dp_third_note_pay_result
            where create_time >= current_date - 1
              and create_time &lt; current_date
              and status_desc = '1'
              <if test="passagewayId != null and passagewayId != ''">
                  and sp_code = #{passagewayId}
              </if>
            group by statisDate,passagewayId
            order by fee desc
           ) a
        LEFT JOIN dp_note_info b
               ON a.passagewayId = b.passageway_id
        limit #{rowsPerPage} offset #{start}
    </select>
</mapper>